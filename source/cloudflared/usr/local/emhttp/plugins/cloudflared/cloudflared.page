Menu="Utilities"
Title="cloudflared"
Icon="cloudflared.png"
---
<?
$conf_file = "/boot/config/plugins/cloudflared/config.yml";
$conf_text = file_get_contents($conf_file);

$creds_file = "/boot/config/plugins/cloudflared/creds.json";
$creds_text = file_get_contents($creds_file);

$cert_file = "/boot/config/plugins/cloudflared/cert.pem";
$cert_text = file_get_contents($cert_file);
?>

<?
exec('cloudflared --version | grep -Po "([0-9]+\.[0-9]+\.[0-9]+)"', $output);
$currentversion = $output[0];
?>

<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>

.row {
  display: flex;
}

/* Create two unequal columns */
.column {
  padding: 10px;
}

.left {
  flex: 1; /* Represents 25% of the container */
}

.right {
  flex: 3; /* Represents 75% of the container */
}
</style>
</head>
<body>

<div class="row">
  <div class="column left">
 <?
 echo "Cloudflared version: $currentversion";
 ?>
 <div style="margin-top: 10px;">
  <input type="button" value="View live logs" onclick="showCloudflaredLogs();">
</div>
 <br>
  </div>
  <div class="column right">
    <h2>Edit config.yml</h2>
    <form markdown="1" id="package_form" name="package_settings" method="POST" action="/update.php" target="progressFrame">
    <input type="hidden" name="#include" value="/webGui/include/update.file.php">
    <input type="hidden" name="#file" value="<?=$conf_file;?>">
    <textarea spellcheck="false" cols="80" rows="22" name="text" style="font-family:bitstream;width:100%"><?=$conf_text;?></textarea>
    <br>
    <input type="submit" value="Save changes"/><input type="button" value="Reset" onclick="setConfigDefault(this.form)">
    </form>
    <br>
    <h2>Edit creds.json</h2>
    <form markdown="1" id="package_form" name="package_settings" method="POST" action="/update.php" target="progressFrame">
    <input type="hidden" name="#include" value="/webGui/include/update.file.php">
    <input type="hidden" name="#file" value="<?=$creds_file;?>">
    <textarea spellcheck="false" cols="80" rows="22" name="text" style="font-family:bitstream;width:100%"><?=$creds_text;?></textarea>
    <br>
    <input type="submit" value="Save changes"/><input type="button" value="Reset" onclick="setCredsDefault(this.form)">
    </form>
    <br>
    <h2>Edit cert.pem</h2>
    <form markdown="1" id="package_form" name="package_settings" method="POST" action="/update.php" target="progressFrame">
    <input type="hidden" name="#include" value="/webGui/include/update.file.php">
    <input type="hidden" name="#file" value="<?=$cert_file;?>">
    <textarea spellcheck="false" cols="80" rows="22" name="text" style="font-family:bitstream;width:100%"><?=$cert_text;?></textarea>
    <br>
    <input type="submit" value="Save changes"/><input type="button" value="Reset" onclick="setCertDefault(this.form)">
    </form>
  </div>
</div>

</body>
</html>

<script>
function setConfigDefault(form) {
  form.elements['text'].value = <?=json_encode($conf_text);?>;
}

function setCredsDefault(form) {
  form.elements['text'].value = <?=json_encode($creds_text);?>;
}

function setCertDefault(form) {
  form.elements['text'].value = <?=json_encode($cert_text);?>;
}

function showCloudflaredLogs() {
  openBox('/plugins/cloudflared/showLogs.php', 'Cloudflared Logs', 800, 1200);
}
</script>
